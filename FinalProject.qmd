---
title: "Data Science for Public Policy"
subtitle: "Final Project"
author: "Ritwika Rituparna - rr1264, Hannah Reynolds - hjr45, Maleeha Hameed - mh2203"
execute:
  warning: false
format:
  html:
    embed-resources: true
---

# Background and Literature Review

# Data Sources

# Data Wrangling

## Load Libraries
```{r}
library(tidyverse)
library(tidymodels)
library (themis)
library (rpart)
library(yardstick)
library(vip)
library(ggplot2)
library(rsample)
library (recipes)
library (parsnip)
library(kknn)
library(dplyr)
library(haven)
```

## Data Cleaning

```{r}

hh_characteristics <- read_dta("/Users/hannahreynolds/Downloads/public_child5_cleaned.dta")

irt_scores <- read_dta("/Users/hannahreynolds/Desktop/GitHub/finalproject/school/master/public_child_irt_scores_panel.dta") %>%
  filter(year == 5) %>%
  select(-eng_theta_pv1, -eng_theta_pv2, -eng_theta_pv3, -eng_theta_pv4, -eng_theta_pv5, -eng_theta_mle, -eng_theta_mle_se, -math_theta_pv1, -math_theta_pv2, -math_theta_pv3, -math_theta_pv4, -math_theta_pv5, -math_theta_mle, -math_theta_mle_se, -urdu_theta_pv1, -urdu_theta_pv2, -urdu_theta_pv3, -urdu_theta_pv4, -urdu_theta_pv5, -urdu_theta_mle, -urdu_theta_mle_se)

scores <- merge(irt_scores, hh_characteristics,  by = "childcode") 

```

## Create Testing & Training Data

```{r}
# Set seed before sampling
set.seed(20211101)

# Create a sample for predictive modelling
scores_split <- initial_split(data = scores)

scores_train <- training(x = scores_split)
scores_test <- testing(x = scores_split)

```

# Exploratory Data Analysis

## Geospatial Analysis of Pakistani Schools

## Data Visualization 
```{r}
average_scores <- scores_train %>%
  group_by(district_name) %>%
  summarize(avg_english = mean(eng_theta_eap, na.rm = TRUE),
            avg_math = mean(math_theta_eap, na.rm = TRUE),
            avg_urdu = mean(urdu_theta_eap, na.rm = TRUE))

average_scores <- tidyr::pivot_longer(average_scores, 
                                      cols = c(avg_english, avg_math, avg_urdu),
                                      names_to = "test_subject",
                                      values_to = "average_score")

ggplot(average_scores, aes(x = district_name, y = average_score, fill = test_subject)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Test Scores by School District",
       x = "School District",
       y = "Average Score",
       fill = "Test Subject") +
  theme_minimal()
```
```{r}
scores_train %>%
ggplot(aes(x = factor(mother_educ), fill = factor(aspiration_education))) +
  geom_bar(position = "dodge") +
  labs(title = "Relationship Between Mother Education and Student Education Aspiration",
       x = "Mother Education",
       y = "Count",
       fill = "Student Education Aspiration (Grade Level)") +
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```
```{r}
average_scores <- scores_train %>%
  filter(aspiration_career < 9) %>%
  group_by(aspiration_career) %>%
  summarize(avg_english = mean(eng_theta_eap, na.rm = TRUE),
            avg_math = mean(math_theta_eap, na.rm = TRUE),
            avg_urdu = mean(urdu_theta_eap, na.rm = TRUE))

average_scores <- tidyr::pivot_longer(average_scores, 
                                      cols = c(avg_english, avg_math, avg_urdu),
                                      names_to = "test_subject",
                                      values_to = "average_score")
average_scores %>%
ggplot(aes(x = factor(aspiration_career, labels = c("Teacher", "Doctor", "Army Forces", "Government Employ", "Private Employ", "Engineer", "Politician", "Farmer")), y = average_score, fill = test_subject)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Average Test Scores by Student Career Aspiration",
       x = "Students' Career Aspiration",
       y = "Average Score",
       fill = "Test Subject") +
  theme_minimal()
```

## Student Math Score Exploratory Analysis

```{r}
scores_train %>%
  ggplot(aes(factor(mother_educ), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Maternal Education Levels on Math Test Scores",
       x = "Maternal Education Levels",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(father_educ), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Paternal Education Levels on Math Test Scores",
       x = "Paternal Education Levels",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
average_math_score_age <- scores_train %>%
  filter(age > 4) %>%
  group_by(age) %>%
  summarize(avg_math_theta_eap = mean(math_theta_eap))

average_math_score_age %>%
  ggplot(aes(x = age, y = avg_math_theta_eap)) +
  geom_line() +
  labs(title = "Effect of Student Age on Average Math Test Scores",
       x = "Student Age",
       y = "Average Math Test Scores") +
  theme_minimal()
```

```{r}
average_math_score_enjoy <- scores_train %>%
  group_by(enjoy_school) %>%
  summarize(avg_math_theta_eap = mean(math_theta_eap))

average_math_score_enjoy %>%
  ggplot(aes(x = enjoy_school, y = avg_math_theta_eap)) +
  geom_bar(stat="identity") + 
  labs(title = "Effect of Student Enjoying School on Math Test Scores",
       x = "Does the Student Enjoy School",
       y = "Average Math Test Scores")+
  theme_minimal()
```

```{r}
scores_train %>%
  filter(!is.na(teacher_treat)) %>%
  ggplot(aes(factor(teacher_treat), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Teacher Treatment on Math Test Scores",
       x = "My Teachers Treat Me Worse than Other Children",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))
```

```{r}
scores_train %>%
  filter(!is.na(peers_treat)) %>%
  ggplot(aes(factor(peers_treat), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Peer Treatment on Math Test Scores",
       x = "My Peers Tease Me at School",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))+
  theme_minimal()
```

```{r}
scores_train %>%
  ggplot(aes(factor(aspiration_education), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Student Education Aspiration on Math Test Scores",
       x = "What is the Highest Level of Education You Would Like to Complete",
       y = "Math Test Scores")+
  theme_minimal() +
  scale_x_discrete(labels = c("Grade 5", "Grade 6", "Grade 7", "Grade 8", "Grade 9", "Grade 10", "Grade 11", "Grade 12", "Grade 13", "Grade 14", "Grade 15", "Grade 16"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(transport_school), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Type of Transportation on Math Test Scores",
       x = "Type of Transportation to School",
       y = "Math Test Scores") +
  theme_minimal() +
  scale_x_discrete(labels = c("Walking", "Cycle", "Bus", "Motor Cycle", "Bullock Cart"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tv), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a TV on Math Test Scores",
       x = "Does the Household Own a TV",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_agri_tool), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having Agricultural Tools on Math Test Scores",
       x = "Does the Household Own Agricultural Tools",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_motorbike), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Motorbike on Math Test Scores",
       x = "Does the Household Own a Motorbike",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tubewell), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Tubewell on Math Test Scores",
       x = "Does the Household Own a Tubewell",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_phone), math_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Phone on Math Test Scores",
       x = "Does the Household Own a Phone",
       y = "Math Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
average_math_score_weight <- scores_train %>%
  group_by(child_weight) %>%
  summarize(avg_math_theta_eap = mean(math_theta_eap))

average_math_score_weight %>%
  ggplot(aes(x = child_weight, y = avg_math_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Weight on Math Test Scores",
       x = "Child Weight (kg)",
       y = "Average Math Test Scores")+
  theme_minimal()
```

```{r}
average_math_score_height <- scores_train %>%
  group_by(child_height) %>%
  summarize(avg_math_theta_eap = mean(math_theta_eap))

average_math_score_height %>%
  ggplot(aes(x = child_height, y = avg_math_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Height on Math Test Scores",
       x = "Student Height (cm)",
       y = "Average Math Test Scores")+
  theme_minimal()
```

## Student English Score Exploratory Analysis
```{r}
scores_train %>%
  ggplot(aes(factor(mother_educ), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Maternal Education Levels on English Test Scores",
       x = "Maternal Education Levels",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(father_educ), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Paternal Education Levels on English Test Scores",
       x = "Paternal Education Levels",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
average_eng_score_age <- scores_train %>%
  filter(age > 4) %>%
  group_by(age) %>%
  summarize(avg_eng_theta_eap = mean(eng_theta_eap))

average_eng_score_age %>%
  ggplot(aes(x = age, y = avg_eng_theta_eap)) +
  geom_line() +
  labs(title = "Effect of Student Age on Average English Test Scores",
       x = "Student Age",
       y = "Average English Test Scores") +
  theme_minimal()
```

```{r}
average_eng_score_enjoy <- scores_train %>%
  group_by(enjoy_school) %>%
  summarize(avg_eng_theta_eap = mean(eng_theta_eap))

average_eng_score_enjoy %>%
  ggplot(aes(x = enjoy_school, y = avg_eng_theta_eap)) +
  geom_bar(stat="identity") + 
  labs(title = "Effect of Student Enjoying School on English Test Scores",
       x = "Does the Student Enjoy School",
       y = "Average English Test Scores")+
  theme_minimal()
```

```{r}
scores_train %>%
  filter(!is.na(teacher_treat)) %>%
  ggplot(aes(factor(teacher_treat), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Teacher Treatment on English Test Scores",
       x = "My Teachers Treat Me Worse than Other Children",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))
```

```{r}
scores_train %>%
  filter(!is.na(peers_treat)) %>%
  ggplot(aes(factor(peers_treat), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Peer Treatment on English Test Scores",
       x = "My Peers Tease Me at School",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))+
  theme_minimal()
```

```{r}
scores_train %>%
  ggplot(aes(factor(aspiration_education), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Student Education Aspiration on English Test Scores",
       x = "What is the Highest Level of Education You Would Like to Complete",
       y = "English Test Scores")+
  theme_minimal() +
  scale_x_discrete(labels = c("Grade 5", "Grade 6", "Grade 7", "Grade 8", "Grade 9", "Grade 10", "Grade 11", "Grade 12", "Grade 13", "Grade 14", "Grade 15", "Grade 16"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(transport_school), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Type of Transportation on English Test Scores",
       x = "Type of Transportation to School",
       y = "English Test Scores") +
  theme_minimal() +
  scale_x_discrete(labels = c("Walking", "Cycle", "Bus", "Motor Cycle", "Bullock Cart"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tv), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a TV on English Test Scores",
       x = "Does the Household Own a TV",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_agri_tool), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having Agricultural Tools on English Test Scores",
       x = "Does the Household Own Agricultural Tools",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_motorbike), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Motorbike on English Test Scores",
       x = "Does the Household Own a Motorbike",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tubewell), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Tubewell on English Test Scores",
       x = "Does the Household Own a Tubewell",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_phone), eng_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Phone on English Test Scores",
       x = "Does the Household Own a Phone",
       y = "English Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
average_eng_score_weight <- scores_train %>%
  group_by(child_weight) %>%
  summarize(avg_eng_theta_eap = mean(eng_theta_eap))

average_eng_score_weight %>%
  ggplot(aes(x = child_weight, y = avg_eng_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Weight on English Test Scores",
       x = "Child Weight (kg)",
       y = "Average English Test Scores")+
  theme_minimal()
```

```{r}
average_eng_score_height <- scores_train %>%
  group_by(child_height) %>%
  summarize(avg_eng_theta_eap = mean(eng_theta_eap))

average_eng_score_height %>%
  ggplot(aes(x = child_height, y = avg_eng_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Height on English Test Scores",
       x = "Child Height (cm)",
       y = "Average English Test Scores")+
  theme_minimal()
```

## Student Urdu Score Exploratory Analysis
```{r}
scores_train %>%
  ggplot(aes(factor(mother_educ), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Maternal Education Levels on Urdu Test Scores",
       x = "Maternal Education Levels",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(father_educ), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Paternal Education Levels on Urdu Test Scores",
       x = "Paternal Education Levels",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Illiterate", "Primary or Less", "Primary to Higher Secondary", "Higher Secondary or Higher"))
```

```{r}
average_urdu_score_age <- scores_train %>%
  filter(age > 4) %>%
  group_by(age) %>%
  summarize(avg_urdu_theta_eap = mean(urdu_theta_eap))

average_urdu_score_age %>%
  ggplot(aes(x = age, y = avg_urdu_theta_eap)) +
  geom_line() +
  labs(title = "Effect of Student Age on Average Urdu Test Scores",
        x = "Student Age",
       y = "Average Urdu Test Scores") +
  theme_minimal()
```

```{r}
average_urdu_score_enjoy <- scores_train %>%
  group_by(enjoy_school) %>%
  summarize(avg_urdu_theta_eap = mean(urdu_theta_eap))

average_urdu_score_enjoy %>%
  ggplot(aes(x = enjoy_school, y = avg_urdu_theta_eap)) +
  geom_bar(stat="identity") + 
  labs(title = "Effect of Student Enjoying School on Urdu Test Scores",
       x = "Does the Student Enjoy School",
       y = "Average Urdu Test Scores")+
  theme_minimal()
```

```{r}
scores_train %>%
  filter(!is.na(teacher_treat)) %>%
  ggplot(aes(factor(teacher_treat), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Teacher Treatment on Urdu Test Scores",
       x = "My Teachers Treat Me Worse than Other Children",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))
```

```{r}
scores_train %>%
  filter(!is.na(peers_treat)) %>%
  ggplot(aes(factor(peers_treat), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Peer Treatment on Urdu Test Scores",
       x = "My Peers Tease Me at School",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("Completely Agree", "Agree", "Somewhat Agree", "Disagree", "Completely Disagree"))+
  theme_minimal()
```

```{r}
scores_train %>%
  ggplot(aes(factor(aspiration_education), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Student Education Aspiration on Urdu Test Scores",
       x = "What is the Highest Level of Education You Would Like to Complete",
       y = "Urdu Test Scores")+
  theme_minimal() +
  scale_x_discrete(labels = c("Grade 5", "Grade 6", "Grade 7", "Grade 8", "Grade 9", "Grade 10", "Grade 11", "Grade 12", "Grade 13", "Grade 14", "Grade 15", "Grade 16"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(transport_school), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Type of Transportation on Urdu Test Scores",
       x = "Type of Transportation to School",
       y = "Urdu Test Scores") +
  theme_minimal() +
  scale_x_discrete(labels = c("Walking", "Cycle", "Bus", "Motor Cycle", "Bullock Cart"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tv), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a TV on Urdu Test Scores",
       x = "Does the Household Own a TV",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_agri_tool), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having Agricultural Tools on Urdu Test Scores",
       x = "Does the Household Own Agricultural Tools",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_motorbike), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Motorbike on Urdu Test Scores",
       x = "Does the Household Own a Motorbike",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_tubewell), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Tubewell on Urdu Test Scores",
       x = "Does the Household Own a Tubewell",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
scores_train %>%
  ggplot(aes(factor(asset_phone), urdu_theta_eap)) +
  geom_boxplot() +
  labs(title = "Effect of Houshold Having a Phone on Urdu Test Scores",
       x = "Does the Household Own a Phone",
       y = "Urdu Test Scores")+
  theme_minimal()+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
average_urdu_score_weight <- scores_train %>%
  group_by(child_weight) %>%
  summarize(avg_urdu_theta_eap = mean(urdu_theta_eap))

average_urdu_score_weight %>%
  ggplot(aes(x = child_weight, y = avg_urdu_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Weight on Urdu Test Scores",
       x = "Child Weight (kg)",
       y = "Average Urdu Test Scores")+
  theme_minimal()
```

```{r}
average_urdu_score_height <- scores_train %>%
  group_by(child_height) %>%
  summarize(avg_urdu_theta_eap = mean(urdu_theta_eap))

average_urdu_score_height %>%
  ggplot(aes(x = child_height, y = avg_urdu_theta_eap)) +
  geom_point() +
  labs(title = "Effect of Student Height on Urdu Test Scores",
       x = "Student Height (cm)",
       y = "Average Urdu Test Scores")+
  theme_minimal()
```

# Data Analysis

## Student Math Score Prediction Analysis

### Create Models

```{r}
score_folds <- vfold_cv(scores_train, v = 10)

# Create Recipe
scores_rec <- recipe(math_theta_eap ~ father_educ + age + enjoy_school + aspiration_education + transport_school + asset_tv + asset_agri_tool + asset_motorbike + asset_tubewell + asset_phone + dist_code + mauza_code, data = scores_train) %>%
  step_dummy(all_nominal_predictors()) %>%
  step_normalize(all_numeric_predictors()) %>%
  step_corr(all_numeric_predictors())

# 3 Model Specifications
linear_model <- linear_reg() %>%
  set_engine("lm")%>%
  set_mode(mode = "regression")

decision_tree_model <- decision_tree() %>%
  set_engine("rpart") %>%
  set_mode(mode = "regression")

knn_model <- nearest_neighbor(neighbors = tune()) %>%
  set_engine("kknn") %>%
  set_mode(mode = "regression")

knn_grid <- grid_regular(neighbors(range = c(1, 15)), levels = 10)
```

### Create Workflows

```{r}
linear_workflow <- workflow() %>%
  add_recipe(scores_rec) %>%
  add_model(linear_model)

decision_tree_workflow <- workflow() %>%
  add_recipe(scores_rec) %>%
  add_model(decision_tree_model)

knn_workflow <- workflow() %>%
  add_recipe(scores_rec) %>%
  add_model(knn_model)
```

### Fit Re-samples

```{r}
linear_fit_rs <- linear_workflow %>%
  fit_resamples(resamples = score_folds,
                control = control_resamples(save_pred = TRUE, save_workflow = TRUE),
                metrics = metric_set(rmse, mae, rsq))

decision_tree_fit_rs <- 
  decision_tree_workflow %>%
  fit_resamples(resamples = score_folds,
                control = control_resamples(save_pred = TRUE),
                metrics = metric_set(rmse, mae, rsq))

knn_fit_rs <- 
  knn_workflow %>%
  tune_grid(resamples = score_folds,
            grid = knn_grid,
            control = control_resamples(save_pred = TRUE),
            metrics = metric_set(rmse, mae, rsq))
```

### Model Estimations

```{r}
# Linear MAE & RMSE 
linear_metrics <- collect_metrics(linear_fit_rs)
print(linear_metrics)

collect_metrics(linear_fit_rs, summarize = FALSE) %>%
  filter(.metric == "rmse") %>%
  ggplot (aes(id, .estimate, group = .estimator)) +
  geom_line() +
  geom_point() +
  labs(title = "Calculated RMSE for Linear Fit Across 10 Folds",
       y = "RMSE_hat")+
  theme_minimal()

linear_rmse <- linear_fit_rs %>%
  collect_metrics() %>%
  filter(.metric == "rmse")


# Decision Tree MAE & RMSE 
decision_tree_metrics <- collect_metrics(decision_tree_fit_rs)
print(decision_tree_metrics)

collect_metrics(decision_tree_fit_rs, summarize = FALSE) %>%
  filter(.metric == "rmse") %>%
  ggplot (aes(id, .estimate, group = .estimator)) +
  geom_line() +
  geom_point() +
  labs(title = "Calculated RMSE for Decision Tree Fit Across 10 Folds",
       y = "RMSE_hat")+
  theme_minimal()

decision_tree_rmse <- decision_tree_fit_rs %>%
  collect_metrics() %>%
  filter(.metric == "rmse")


# KNN MAE & RMSE 
knn_metrics <- collect_metrics(knn_fit_rs)
print(knn_metrics)

collect_metrics(knn_fit_rs, summarize = FALSE) %>%
  filter(.metric == "rmse") %>%
  ggplot (aes(id, .estimate, group = .estimator)) +
  geom_line() +
  geom_point() +
  labs(title = "Calculated RMSE for KNN Fit Across 10 Folds",
       y = "RMSE_hat")+
  theme_minimal()

knn_rmse <- knn_fit_rs %>%
  collect_metrics() %>%
  filter(.metric == "rmse") %>%
  summarize(avg_rmse = mean(mean))

knn_mean_rmse <- collect_metrics(knn_fit_rs) %>%
  filter(.metric == "rmse") %>%
  summarize(avg_rms = mean(mean))

```

### Final Prediction

```{r}
dt_best <- decision_tree_fit_rs %>%
  select_best(metric = "rmse")

dt_final <- finalize_workflow(decision_tree_workflow, parameters = dt_best)

dt_final_fit <- dt_final %>%
  fit(data = scores_train)

dt_predictions <- dt_final_fit %>%
  predict(new_data = scores_test)

dt_final_rmse <- bind_cols(
  scores_test %>% 
    select(math_theta_eap),
  dt_predictions %>% 
    select(.pred)) %>%
  rmse(truth = math_theta_eap, estimate = .pred)

dt_final_rmse 
```

## Student English Score Prediction Analysis

## Student Urdu Score Prediction Analysis

# Discussion of Results
